package jetbrains.mps.ide.newModuleDialogs;

/*Generated by MPS */

import com.intellij.openapi.ui.DialogWrapper;
import com.intellij.openapi.ui.ValidationInfo;
import jetbrains.mps.project.Project;
import jetbrains.mps.smodel.Language;
import jetbrains.mps.ide.ui.dialogs.modules.NewLanguageSettings;
import org.jetbrains.annotations.Nullable;
import jetbrains.mps.ide.project.ProjectHelper;
import javax.swing.JComponent;
import com.intellij.openapi.project.ex.ProjectEx;
import com.intellij.openapi.components.StorageScheme;
import jetbrains.mps.ide.newSolutionDialog.NewModuleUtil;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import jetbrains.mps.project.MPSProject;
import jetbrains.mps.project.StandaloneMPSProject;
import jetbrains.mps.project.Solution;
import java.io.IOException;
import org.apache.log4j.Level;
import jetbrains.mps.project.MPSExtentions;
import org.apache.log4j.Logger;
import org.apache.log4j.LogManager;

public class NewLanguageDialog extends DialogWrapper {

  private final Project myProject;
  private Language myResult;
  private String myError = null;
  private NewLanguageSettings myLanguageSettings;
  private final String myVirtualFolder;

  public NewLanguageDialog(Project project, @Nullable String virtualFolder) {
    super(ProjectHelper.toIdeaProject(project));
    setTitle("New Language");
    setOKButtonText("&OK");
    setCancelButtonText("Ca&ncel");

    myProject = project;
    myVirtualFolder = virtualFolder;

    init();
  }
  @Nullable
  protected JComponent createCenterPanel() {
    if (myLanguageSettings == null) {
      myLanguageSettings = new NewLanguageSettings((myProject != null ? ((((ProjectEx) ProjectHelper.toIdeaProject(myProject)).getStateStore().getStorageScheme() != StorageScheme.DIRECTORY_BASED ? myProject.getProjectFile().getParentFile().getAbsolutePath() : myProject.getProjectFile().getAbsolutePath())) : null));
    }
    return myLanguageSettings;
  }

  @Override
  protected ValidationInfo doValidate() {
    String errorText = check();
    if (errorText == null) return null;
    else return new ValidationInfo(errorText);
  }

  @Override
  protected void doOKAction() {
    super.doOKAction();

    NewModuleUtil.runModuleCreation(myProject, new _FunctionTypes._void_P0_E0() {
      public void invoke() {
        Language language = NewModuleUtil.createLanguage(myLanguageSettings.getLanguageName(), myLanguageSettings.getLanguageLocation(), (MPSProject) myProject);
        ((StandaloneMPSProject) myProject).setFolderFor(language, myVirtualFolder);

        try {
          if (myLanguageSettings.isRuntimeSolutionNeeded()) {
            Solution runtimeSolution = NewModuleUtil.createRuntimeSolution(language, myLanguageSettings.getLanguageLocation(), (MPSProject) myProject);
            ((StandaloneMPSProject) myProject).setFolderFor(runtimeSolution, myVirtualFolder);
          }
          if (myLanguageSettings.isSandboxSolutionNeeded()) {
            Solution sandboxSolution = NewModuleUtil.createSandboxSolution(language, myLanguageSettings.getLanguageLocation(), (MPSProject) myProject);
            ((StandaloneMPSProject) myProject).setFolderFor(sandboxSolution, myVirtualFolder);
          }
        } catch (IOException e) {
          // todo: ! 
          if (LOG.isEnabledFor(Level.ERROR)) {
            LOG.error("Cannot create runtime / sandbox module", e);
          }
        }

        myResult = language;
      }
    });
  }
  @Nullable
  @Override
  public JComponent getPreferredFocusedComponent() {
    return myLanguageSettings.getPreferredFocusedComponent();
  }

  public Language getLangauge() {
    return myResult;
  }
  @Nullable
  private String check() {
    myError = NewModuleUtil.check(MPSExtentions.DOT_LANGUAGE, myLanguageSettings.getLanguageName(), myLanguageSettings.getLanguageLocation());
    return myError;
  }
  protected static Logger LOG = LogManager.getLogger(NewLanguageDialog.class);
}
